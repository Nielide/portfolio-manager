<!DOCTYPE html>
<html lang="zh-CN" class="">
<head>
    <link rel="icon" href="logo.png" type="png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AssetHub</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400;500;700;900&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Google Sans"', 'Roboto', 'sans-serif'],
                        mono: ['"Roboto Mono"', 'monospace'],
                    },
                    colors: {
                        googleBlue: '#1a73e8',
                        googleRed: '#ea4335',
                        googleYellow: '#fbbc04',
                        googleGreen: '#34a853',
                        darkSurface: '#303134',
                        darkBg: '#202124',
                        darkBorder: '#5f6368',
                        darkText: '#e8eaed',
                        darkTextSec: '#9aa0a6'
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --bg-body: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --border-color: #dadce0;
            --input-hover: #f1f3f4;
            --input-focus-bg: #ffffff;
        }

        html.dark {
            --bg-body: #202124;
            --bg-card: #303134;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --border-color: #3c4043;
            --input-hover: #3c4043;
            --input-focus-bg: #303134;
        }

        html { font-size: 19px; } 
        body { 
            background-color: var(--bg-body); 
            color: var(--text-primary); 
            transition: background-color 0.3s, color 0.3s;
        }
        
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        .g-card-static {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .input-google {
            background-color: transparent;
            border: 1px solid transparent;
            border-bottom: 1px solid transparent;
            transition: all 0.2s ease;
            color: var(--text-primary);
            padding: 2px 4px;
        }
        .input-google:hover { background-color: var(--input-hover); border-radius: 0.25rem; }
        .input-google:focus {
            background-color: var(--input-focus-bg);
            border: 1px solid #1a73e8;
            border-radius: 0.25rem;
            outline: none;
            box-shadow: 0 1px 2px rgba(26,115,232,0.1);
        }

        .btn-add {
            color: #1a73e8;
            cursor: pointer;
            font-size: 0.75rem; 
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.3rem 0.6rem;
            border-radius: 0.25rem;
            transition: background 0.2s;
        }
        .btn-add:hover { background-color: rgba(26, 115, 232, 0.1); }

        .btn-action {
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.8rem;
            border-radius: 2rem;
            border: 1px solid var(--border-color);
            background-color: var(--bg-card);
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        .btn-action:hover {
            background-color: var(--input-hover);
            color: var(--text-primary);
            border-color: var(--text-secondary);
        }

        .icon-glass { width: 1.2rem; height: 1.2rem; fill: none; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; }

        .pro-grid-header, .pro-grid-row {
            display: grid;
            grid-template-columns: 1.2fr 1fr 1fr 1fr 1.5fr 2fr 0.8fr 40px;
            gap: 12px;
            align-items: center;
        }
        
        .cash-grid-header, .cash-grid-row {
            display: grid;
            grid-template-columns: 1.4fr 1fr 1.3fr 0.8fr 40px;
            gap: 12px;
            align-items: center;
        }

        #delete-popover {
            transition: opacity 0.1s ease-in-out, transform 0.1s ease-in-out;
        }
        
        /* Transition for sync panel */
        #sync-panel {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out, padding 0.3s;
            overflow: hidden;
        }
        #sync-panel.hidden-panel {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            border: none;
            margin: 0;
        }
    </style>
</head>
<body class="min-h-screen py-6 font-sans" onclick="handleBodyClick(event)">

    <div class="w-full px-[30px]">
        
        <header class="mb-6 flex justify-between items-center px-1">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-blue-50 dark:bg-blue-900/20 flex items-center justify-center text-googleBlue border border-blue-100 dark:border-blue-800">
                    <svg class="icon-glass w-6 h-6" viewBox="0 0 24 24" stroke="currentColor">
                        <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                    </svg>
                </div>
                <div><h1 class="text-xl font-normal text-textPrimary dark:text-darkText">AssetHub</h1></div>
            </div>
            
            <div class="flex items-center gap-3">
                <button onclick="toggleTheme()" class="btn-action" id="theme-btn" title="切换主题">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </button>

                <button onclick="toggleSyncPanel()" class="btn-action" title="GitHub云同步">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
                    </svg>
                </button>

                <div class="flex gap-2 mr-2">
                    <button onclick="exportData()" class="btn-action" title="导出数据"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg> 导出</button>
                    <button onclick="document.getElementById('file-import').click()" class="btn-action" title="导入数据"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg> 导入</button>
                    <input type="file" id="file-import" style="display: none;" accept=".json" onchange="importData(this)">
                </div>

                        <div class="flex items-center gap-2 px-3 py-1.5 rounded-full border border-borderSubtle dark:border-darkBorder bg-white dark:bg-darkSurface shadow-sm transition-colors">
                            <svg onclick="fetchLiveRate()" class="w-3.5 h-3.5 text-textSecondary dark:text-darkTextSec cursor-pointer hover:text-googleBlue transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" title="最新汇率">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            <span class="text-xs font-medium text-textSecondary dark:text-darkTextSec whitespace-nowrap">汇率</span>
                            <input type="number" id="fx-rate" value="7.25" step="0.0001" class="w-16 text-right font-mono text-sm font-bold text-googleBlue bg-transparent focus:outline-none p-0 m-0 border-none appearance-none">
                        </div>
            </div>
        </header>

        <div id="sync-panel" class="hidden-panel mb-6 p-5 g-card-static">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-sm font-bold text-googleBlue uppercase tracking-wide flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            系统设置
        </h3>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
        <div>
            <label class="text-[0.65rem] font-bold text-textSecondary dark:text-darkTextSec uppercase tracking-wider block mb-1">GitHub Token</label>
            <input type="password" id="gh-token" class="input-google w-full text-sm font-mono border-b border-borderSubtle dark:border-darkBorder focus:border-googleBlue" placeholder="TOKEN">
        </div>
        <div>
            <label class="text-[0.65rem] font-bold text-textSecondary dark:text-darkTextSec uppercase tracking-wider block mb-1">仓库</label>
            <input type="text" id="gh-repo" class="input-google w-full text-sm font-mono border-b border-borderSubtle dark:border-darkBorder focus:border-googleBlue" placeholder="user/repo">
        </div>
        <div>
            <label class="text-[0.65rem] font-bold text-textSecondary dark:text-darkTextSec uppercase tracking-wider block mb-1">数据路径</label>
            <input type="text" id="gh-path" class="input-google w-full text-sm font-mono border-b border-borderSubtle dark:border-darkBorder focus:border-googleBlue" placeholder="data.json">
        </div>
        <div>
            <label class="text-[0.65rem] font-bold text-googleBlue uppercase tracking-wider block mb-1">Finnhub Key</label>
            <input type="password" id="finnhub-token" class="input-google w-full text-sm font-mono border-b border-borderSubtle dark:border-darkBorder focus:border-googleBlue" placeholder="KEY">
        </div>
    </div>
    <div class="flex gap-3 justify-end">
        <button onclick="saveSyncSettings()" class="btn-action hover:bg-gray-100 dark:hover:bg-gray-700">保存配置</button>
        <button onclick="pullFromGithub()" class="btn-action text-googleGreen border-googleGreen hover:bg-green-50 dark:hover:bg-green-900/20">同步数据</button>
        <button onclick="pushToGithub()" class="btn-action text-white bg-googleBlue border-transparent hover:bg-blue-600 shadow-sm">备份数据</button>
    </div>
</div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-5">

            <div class="lg:col-span-2 flex flex-col gap-4">
                <div class="g-card-static p-6 flex-shrink-0">
                    <div class="flex items-center gap-2 mb-1">
                        <p class="text-xs font-medium text-textSecondary dark:text-darkTextSec">账户总净值</p>
                        <button onclick="togglePrivacy()" class="text-textSecondary dark:text-darkTextSec hover:text-googleBlue focus:outline-none transition-colors" title="隐藏/显示金额">
                            <svg id="eye-open" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                            <svg id="eye-closed" class="w-4 h-4 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                            </svg>
                     </button>
                   </div>
                    <h2 class="text-3xl lg:text-4xl font-normal text-textPrimary dark:text-darkText font-mono tracking-tight mb-2 truncate" id="total-nw-cny">¥0</h2>
                </div>

                <div class="g-card-static overflow-hidden flex-shrink-0">
                    <div class="p-4 border-b border-borderSubtle dark:border-darkBorder flex flex-col xl:flex-row xl:justify-between xl:items-center gap-2 hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                        <span class="text-sm text-textSecondary dark:text-darkTextSec">USD</span>
                        <div class="text-left xl:text-right">
                            <div class="text-2xl font-normal text-googleBlue font-mono" id="total-usd-assets">$0</div>
                            <div id="total-usd-cny-equiv" style="display: none;">0</div>
                        </div>
                    </div>
                    <div class="p-4 flex flex-col xl:flex-row xl:justify-between xl:items-center gap-2 hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                        <span class="text-sm text-textSecondary dark:text-darkTextSec">CNY</span>
                        <div class="text-left xl:text-right">
                            <div class="text-2xl font-normal text-googleYellow font-mono" id="total-cny-assets">¥0</div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col gap-4 flex-1">
                    <div class="g-card-static p-4 flex flex-col flex-1">
                        <div class="w-full mb-2"><h3 class="text-[0.7rem] font-bold text-googleBlue uppercase tracking-wider">美股分布</h3></div>
                        <div class="flex-1 flex flex-col xl:flex-row items-center justify-center gap-4">
                            <div class="h-24 w-24 relative flex-shrink-0"><canvas id="chart-us-sub"></canvas></div>
                            <div id="legend-us" class="space-y-1"></div>
                        </div>
                    </div>
                    <div class="g-card-static p-4 flex flex-col flex-1">
                        <div class="w-full mb-2"><h3 class="text-[0.7rem] font-bold text-googleYellow uppercase tracking-wider">A股分布</h3></div>
                        <div class="flex-1 flex flex-col xl:flex-row items-center justify-center gap-4">
                            <div class="h-24 w-24 relative flex-shrink-0"><canvas id="chart-cn-sub"></canvas></div>
                            <div id="legend-cn" class="space-y-1"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 flex flex-col gap-4">
                <div class="g-card-static p-6 relative flex-1 flex flex-col">
                    <div class="mb-4 text-left"><h2 class="text-sm font-bold text-textPrimary dark:text-darkText uppercase tracking-wide">资产分布</h2></div>
                    <div class="w-full flex-1 min-h-[21rem] relative flex items-center justify-center">
                        <canvas id="chart-main"></canvas>
                        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                       <span class="text-2xl font-bold text-textPrimary dark:text-darkText mt-1">AssetHub</span>
                        </div>
                    </div>
                    <div class="mt-6 flex flex-wrap justify-center gap-4 text-center px-2 flex-shrink-0">
                        <div class="flex flex-col items-center"><span class="w-8 h-1 bg-googleBlue mb-1 rounded-full"></span><p class="text-xs font-bold text-textPrimary dark:text-darkText">美股</p></div>
                        <div class="flex flex-col items-center"><span class="w-8 h-1 bg-googleYellow mb-1 rounded-full"></span><p class="text-xs font-bold text-textPrimary dark:text-darkText">A股</p></div>
                        <div class="flex flex-col items-center"><span class="w-8 h-1 bg-googleGreen mb-1 rounded-full"></span><p class="text-xs font-bold text-textPrimary dark:text-darkText">现金</p></div>
                    </div>
                </div>
                <div class="g-card-static p-6 flex-shrink-0">
                    <div class="flex justify-between items-center mb-4 border-b border-borderSubtle dark:border-darkBorder pb-2">
                        <h2 class="text-sm font-bold text-googleGreen uppercase tracking-wider">流动性</h2>
                        <span class="text-[0.65rem] bg-green-50 dark:bg-green-900/30 text-googleGreen px-2 py-1 rounded">>15%</span>
                    </div>
                    <div class="flex flex-col gap-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-textSecondary dark:text-darkTextSec mb-1">现金占比</p>
                                <div class="text-2xl font-bold text-googleGreen font-mono" id="cash-ratio">0%</div>
                            </div>
                            <div class="w-16 h-16 relative"><canvas id="chart-cash-sub"></canvas></div>
                        </div>
                        <div class="w-full bg-gray-100 dark:bg-gray-700 rounded-full h-2 overflow-hidden">
                            <div id="cash-bar" class="bg-googleGreen h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-6 flex flex-col gap-4">
                <div class="g-card-static overflow-hidden">
                    <div class="px-5 py-3 border-b border-borderSubtle dark:border-darkBorder bg-gray-50 dark:bg-gray-800 flex justify-between items-center">
    <div class="flex items-center gap-2">
        <div class="w-1 h-4 bg-googleBlue rounded-full"></div>
        <h2 class="text-sm font-bold text-textPrimary dark:text-darkText uppercase tracking-wide">USD</h2>
        <svg onclick="updateUsStockPrices()" class="w-3.5 h-3.5 text-textSecondary cursor-pointer hover:text-googleBlue transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" title="更新股价">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
    </div>
    <div class="btn-add" onclick="addItem('usd')"><svg class="icon-glass w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg> ADD</div>
</div>
                    <div class="bg-white dark:bg-darkSurface transition-colors">
                        <div class="pro-grid-header px-4 py-2 border-b border-borderSubtle dark:border-darkBorder text-[0.6rem] font-bold text-textSecondary dark:text-darkTextSec uppercase tracking-wider">
                            <div>代码</div>
                            <div class="text-right">持仓</div>
                            <div class="text-right">成本</div>
                            <div class="text-right">现价</div>
                            <div class="text-right text-googleBlue">市值</div>
                            <div class="text-right">盈亏/率</div>
                            <div class="text-right">占比</div>
                            <div></div>
                        </div>
                        <div id="usd-inputs" class="divide-y divide-borderSubtle dark:divide-darkBorder"></div>
                    </div>
                </div>

                <div class="g-card-static overflow-hidden">
                    <div class="px-5 py-3 border-b border-borderSubtle dark:border-darkBorder bg-gray-50 dark:bg-gray-800 flex justify-between items-center">
                        <div class="flex items-center gap-2"><div class="w-1 h-4 bg-googleYellow rounded-full"></div><h2 class="text-sm font-bold text-textPrimary dark:text-darkText uppercase tracking-wide">CNY</h2></div>
                        <div class="btn-add" onclick="addItem('cn')"><svg class="icon-glass w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg> ADD</div>
                    </div>
                    <div class="bg-white dark:bg-darkSurface transition-colors">
                        <div class="pro-grid-header px-4 py-2 border-b border-borderSubtle dark:border-darkBorder text-[0.6rem] font-bold text-textSecondary dark:text-darkTextSec uppercase tracking-wider">
                            <div>名称</div>
                            <div class="text-right">持仓</div>
                            <div class="text-right">成本</div>
                            <div class="text-right">现价</div>
                            <div class="text-right text-googleYellow">市值</div>
                            <div class="text-right">盈亏/率</div>
                            <div class="text-right">占比</div>
                            <div></div>
                        </div>
                        <div id="cn-inputs" class="divide-y divide-borderSubtle dark:divide-darkBorder"></div>
                    </div>
                </div>

                <div class="g-card-static overflow-hidden">
                    <div class="px-5 py-3 border-b border-borderSubtle dark:border-darkBorder bg-gray-50 dark:bg-gray-800 flex justify-between items-center">
                        <div class="flex items-center gap-2"><div class="w-1 h-4 bg-googleGreen rounded-full"></div><h2 class="text-sm font-bold text-textPrimary dark:text-darkText uppercase tracking-wide">CASH</h2></div>
                        <div class="btn-add" onclick="addItem('cash')"><svg class="icon-glass w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg> ADD</div>
                    </div>
                    <div class="bg-white dark:bg-darkSurface transition-colors">
                        <div class="cash-grid-header px-4 py-2 border-b border-borderSubtle dark:border-darkBorder text-[0.6rem] font-bold text-textSecondary dark:text-darkTextSec uppercase tracking-wider">
                            <div>类型</div>
                            <div class="text-right">金额</div>
                            <div class="text-right">RMB估值</div>
                            <div class="text-right">占比</div>
                            <div></div>
                        </div>
                        <div id="cash-inputs" class="divide-y divide-borderSubtle dark:divide-darkBorder"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="delete-popover" class="hidden absolute z-50 bg-white dark:bg-[#303134] shadow-lg border border-gray-200 dark:border-gray-600 rounded-lg p-2 opacity-0 transform scale-95 origin-top-right w-40">
        <p class="text-xs text-textPrimary dark:text-darkText font-medium text-center mb-2 p-1">确认删除?</p>
        <div class="flex gap-2 justify-center">
            <button onclick="closePopover()" class="px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 rounded text-textSecondary dark:text-darkTextSec">取消</button>
            <button id="popover-confirm-btn" class="px-2 py-1 text-xs bg-googleRed text-white rounded hover:bg-red-600 shadow-sm">删除</button>
        </div>
    </div>

    <script>
        const defaultState = {
            usd: [
                { id: '1', ticker: 'VOO', shares: 88888, cost: 88888, price: 88888 },
                { id: '2', ticker: 'QQQ', shares: 88888, cost: 88888, price: 88888 },
            ],
            cn: [
                { id: '5', ticker: 'ETF', shares: 88888, cost: 8, price: 8 },
                { id: '6', ticker: 'ETF', shares: 88888, cost: 8, price: 8 }
            ],
            cash: [
                { id: '7', ticker: 'USD', amount: 88889, currency: 'USD' },
                { id: '8', ticker: 'CNY', amount: 88888, currency: 'CNY' }
            ],
            fxRate: 7
        };

        let savedState = localStorage.getItem('portfolioData');
        let state = savedState ? JSON.parse(savedState) : defaultState;
        if(state.fxRate) document.getElementById('fx-rate').value = state.fxRate;

        // Privacy Mode State
        let isPrivacyMode = localStorage.getItem('portfolio_privacy') === 'true';

        let charts = {};
        let itemToDelete = null;

   function formatMoney(num, currency) {
    const symbol = currency === 'USD' ? '$' : '¥';
    // 直接拼接符号和整数部分，彻底杜绝多余字母
    return `${symbol}${Math.round(num)}`;
}
        
        function saveData() { 
            state.fxRate = parseFloat(document.getElementById('fx-rate').value) || 7.25; 
            localStorage.setItem('portfolioData', JSON.stringify(state)); 
        }

        // --- GitHub Sync Logic ---
        function toggleSyncPanel() {
            const panel = document.getElementById('sync-panel');
            if (panel.classList.contains('hidden-panel')) {
                panel.classList.remove('hidden-panel');
                loadSyncSettings();
            } else {
                panel.classList.add('hidden-panel');
            }
        }

        function saveSyncSettings() {
    localStorage.setItem('gh_token', document.getElementById('gh-token').value);
    localStorage.setItem('gh_repo', document.getElementById('gh-repo').value);
    localStorage.setItem('gh_path', document.getElementById('gh-path').value);
    // 新增：保存 Finnhub Key
    localStorage.setItem('finnhub_key', document.getElementById('finnhub-token').value);
    alert('配置已保存 (本地)');
}

function loadSyncSettings() {
    document.getElementById('gh-token').value = localStorage.getItem('gh_token') || '';
    document.getElementById('gh-repo').value = localStorage.getItem('gh_repo') || '';
    document.getElementById('gh-path').value = localStorage.getItem('gh_path') || 'data.json';
    // 新增：读取 Finnhub Key
    document.getElementById('finnhub-token').value = localStorage.getItem('finnhub_key') || '';
}

        async function pushToGithub() {
            const token = localStorage.getItem('gh_token');
            const repo = localStorage.getItem('gh_repo');
            const path = localStorage.getItem('gh_path');
            if (!token || !repo) return alert('请先保存 GitHub 配置');

            const url = `https://api.github.com/repos/${repo}/contents/${path}`;
            let sha = '';
            try {
                const res = await fetch(url, { headers: { Authorization: `token ${token}` } });
                if (res.ok) {
                    const data = await res.json();
                    sha = data.sha;
                }
            } catch (e) {}

            const content = btoa(unescape(encodeURIComponent(JSON.stringify(state, null, 2))));
            const body = { message: "Update portfolio data via Web", content: content, sha: sha };

            try {
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (response.ok) alert('推送成功！');
                else {
                    const err = await response.json();
                    alert('推送失败: ' + (err.message || '未知错误'));
                }
            } catch(e) { alert('网络错误'); }
        }

        async function pullFromGithub() {
            const token = localStorage.getItem('gh_token');
            const repo = localStorage.getItem('gh_repo');
            const path = localStorage.getItem('gh_path');
            if (!token || !repo) return alert('请先保存 GitHub 配置');

            const url = `https://api.github.com/repos/${repo}/contents/${path}`;
            try {
                const res = await fetch(url, { headers: { Authorization: `token ${token}` } });
                if (res.ok) {
                    const data = await res.json();
                    const jsonStr = decodeURIComponent(escape(atob(data.content)));
                    state = JSON.parse(jsonStr);
                    if(state.fxRate) document.getElementById('fx-rate').value = state.fxRate;
                    saveData();
                    calculate();
                    renderAllRows();
                    alert('拉取成功！');
                } else {
                    alert('拉取失败，请检查配置或文件是否存在');
                }
            } catch (e) { alert('网络错误'); }
        }

        // --- Privacy Logic ---
        function togglePrivacy() {
            isPrivacyMode = !isPrivacyMode;
            localStorage.setItem('portfolio_privacy', isPrivacyMode);
            updatePrivacyUI();
            calculate();
        }

        function updatePrivacyUI() {
            const openEye = document.getElementById('eye-open');
            const closedEye = document.getElementById('eye-closed');
            if (isPrivacyMode) {
                openEye.classList.add('hidden');
                closedEye.classList.remove('hidden');
            } else {
                openEye.classList.remove('hidden');
                closedEye.classList.add('hidden');
            }
        }

        // --- Data Logic ---
        function exportData() {
            saveData(); 
            const jsonStr = JSON.stringify(state, null, 2);
            const blob = new Blob([jsonStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `portfolio_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = e => { try { const d = JSON.parse(e.target.result); if(d.usd){ state = d; if(state.fxRate) document.getElementById('fx-rate').value = state.fxRate; saveData(); calculate(); renderAllRows(); alert('导入成功'); } } catch(e){alert('文件格式错误');} input.value=''; };
            r.readAsText(f);
        }

        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateChartTheme(isDark);
        }

        function loadTheme() {
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                updateChartTheme(true);
            }
        }

        function updateChartTheme(isDark) {
            const textColor = isDark ? '#e8eaed' : '#5f6368';
            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = isDark ? '#3c4043' : '#e5e7eb';
            Object.values(charts).forEach(chart => {
                if(chart.options.plugins.tooltip) {
                    chart.options.plugins.tooltip.backgroundColor = isDark ? '#303134' : '#fff';
                    chart.options.plugins.tooltip.bodyColor = isDark ? '#e8eaed' : '#5f6368';
                    chart.options.plugins.tooltip.borderColor = isDark ? '#5f6368' : '#dadce0';
                }
                chart.update();
            });
        }

        function generateShades(baseHex, count) {
            const p = { 'blue': ['#1a73e8','#4285f4','#669df6','#8ab4f8','#aecbfa','#d2e3fc'], 'yellow': ['#f9ab00','#fbbc04','#fcd965','#fdd663','#fde293','#feefc3'], 'green': ['#188038','#34a853','#5bb974','#81c995','#a8dab5','#ceead6'] };
            let k = 'blue'; if(baseHex.includes('fbbc04')) k='yellow'; if(baseHex.includes('34a853')) k='green';
            let c=[]; for(let i=0; i<count; i++) c.push(p[k][i%p[k].length]); return c;
        }

        function updateCustomLegend(id, labels, colors) {
            const c = document.getElementById(id); if(!c) return;
            let h = ''; labels.forEach((l,i)=>{ h+=`<div class="flex items-center gap-3"><span class="w-1.5 h-1.5 rounded-full flex-shrink-0" style="background-color:${colors[i]}"></span><span class="text-xs font-bold text-gray-900 dark:text-gray-100 truncate tracking-tight">${l}</span></div>`; });
            c.innerHTML = h;
        }

        const segmentLabelPlugin = {
            id: 'segmentLabels',
            afterDatasetsDraw(chart, args, pluginOptions) {
                const { ctx, data } = chart;
                ctx.save();
                const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                
                chart.getDatasetMeta(0).data.forEach((datapoint, index) => {
                    const value = data.datasets[0].data[index];
                    const percentage = total > 0 ? (value / total * 100) : 0;
                    
                    if (percentage > 5) { 
                        const { x, y } = datapoint.tooltipPosition();
                        ctx.font = 'bold 18px "Roboto Mono"';
                        ctx.fillStyle = '#ffffff';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(percentage.toFixed(0) + '%', x, y);
                    }
                });
                ctx.restore();
            }
        };

        // --- 新增：自动获取最新汇率 ---
async function fetchLiveRate() {
    const icon = document.querySelector('svg[onclick="fetchLiveRate()"]');
    if(icon) icon.classList.add('animate-spin'); // 增加旋转动画
    
    try {
        // 使用免费 API 获取汇率
        const response = await fetch('https://open.er-api.com/v6/latest/USD');
        const data = await response.json();
        const rate = data.rates.CNY;
        
        if (rate) {
            document.getElementById('fx-rate').value = rate.toFixed(4); // 更新输入框
            saveData();  // 保存数据
            calculate(); // 重新计算
           // alert(`汇率已更新: 1 USD = ${rate} CNY`); // 这行已被注释，不再弹窗
        }
    } catch (error) {
        console.error(error);
        alert('获取失败，请检查网络'); // 建议保留错误弹窗，方便排查网络问题
    } finally {
        if(icon) icon.classList.remove('animate-spin'); // 停止旋转
    }
}
// --- 自动更新美股价格 (Finnhub) ---
async function updateUsStockPrices() {
    const apiKey = localStorage.getItem('finnhub_key');
    
    // 安全检查：如果没填 Key，就不执行
    if (!apiKey) {
        alert('请先在配置面板(云朵图标)中填写 Finnhub API Key');
        toggleSyncPanel(); // 自动打开面板方便用户填
        return;
    }

    const icon = document.querySelector('svg[onclick="updateUsStockPrices()"]');
    if(icon) icon.classList.add('animate-spin');

    let updatedCount = 0;

    // 遍历所有美股持仓
    for (let item of state.usd) {
        // 跳过没名字的或者 ticker 为空的
        if (!item.ticker || item.ticker === 'New') continue;

        try {
            // 请求 Finnhub
            const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${item.ticker}&token=${apiKey}`);
            const data = await res.json();
            
            // data.c 是当前价格 (Current Price)
            if (data.c) {
                item.price = data.c; // 更新内存中的价格
                updatedCount++;
            }
        } catch (e) {
            console.error(`更新 ${item.ticker} 失败`, e);
        }
    }

    if (updatedCount > 0) {
        saveData();      // 保存到本地
        calculate();     // 重新计算总资产
        renderAllRows(); // 刷新界面显示
        // 只有在全部更新完后，静默完成，不弹窗，只停止旋转
    } else {
        alert('未更新任何数据，请检查股票代码是否正确 (如 AAPL, TSLA)');
    }

    if(icon) icon.classList.remove('animate-spin');
}
        function calculate() {
            const fx = parseFloat(document.getElementById('fx-rate').value) || 7;
            
            const totalUsdStockVal = state.usd.reduce((a, i) => a + (i.shares * i.price), 0);
            const totalCnStockVal = state.cn.reduce((a, i) => a + (i.shares * i.price), 0);
            
            let totalUsdCashVal = 0, totalRmbCashVal = 0;
            state.cash.forEach(i => { if(i.currency === 'USD') totalUsdCashVal += i.amount; else totalRmbCashVal += i.amount; });
            const totalCashValRmb = (totalUsdCashVal * fx) + totalRmbCashVal;

            const totalUsdAssets = totalUsdStockVal + totalUsdCashVal;
            const totalRmbAssets = totalCnStockVal + totalRmbCashVal;
            const grandTotal = (totalUsdAssets * fx) + totalRmbAssets;
            const cashRatio = grandTotal > 0 ? (totalCashValRmb / grandTotal) * 100 : 0;

            // Updated Privacy Logic
            document.getElementById('total-nw-cny').innerText = isPrivacyMode ? '****' : formatMoney(grandTotal, 'CNY');
            
            document.getElementById('total-usd-assets').innerText = formatMoney(totalUsdAssets, 'USD');
            document.getElementById('total-usd-cny-equiv').innerText = Math.round(totalUsdAssets * fx);
            document.getElementById('total-cny-assets').innerText = formatMoney(totalRmbAssets, 'CNY');
            
            const re = document.getElementById('cash-ratio');
            re.innerText = cashRatio.toFixed(1) + '%';
            re.className = `text-2xl font-bold font-mono ${cashRatio < 15 ? 'text-googleRed' : 'text-googleGreen'}`;
            document.getElementById('cash-bar').style.width = Math.min(cashRatio, 100) + '%';
            document.getElementById('cash-bar').className = `h-full rounded-full transition-all duration-500 ${cashRatio < 15 ? 'bg-googleRed' : 'bg-googleGreen'}`;

            updateChart(charts.main, [(totalUsdStockVal * fx), totalCnStockVal, totalCashValRmb]);
            
            const usLabels = state.usd.map(i => i.ticker);
            const usData = state.usd.map(i => i.shares * i.price);
            const cnLabels = state.cn.map(i => i.ticker);
            const cnData = state.cn.map(i => i.shares * i.price);
            const cashLabels = state.cash.map(i => i.ticker);
            const cashData = state.cash.map(i => i.currency === 'USD' ? i.amount * fx : i.amount);

            const uc = generateShades('#1a73e8', usData.length);
            updateSubChart(charts.usSub, usLabels, usData, uc);
            updateCustomLegend('legend-us', usLabels, uc);

            const cc = generateShades('#fbbc04', cnData.length);
            updateSubChart(charts.cnSub, cnLabels, cnData, cc);
            updateCustomLegend('legend-cn', cnLabels, cc);

            const kc = generateShades('#34a853', cashData.length);
            updateSubChart(charts.cashSub, cashLabels, cashData, kc);
            updateCustomLegend('legend-cash', cashLabels, kc);

            updateRowValues('usd', state.usd, totalUsdStockVal, '$');
            updateRowValues('cn', state.cn, totalCnStockVal, '¥');
            updateCashRowValues(totalCashValRmb, fx);

            saveData();
        }

        function renderAllRows() {
            renderRows('usd', state.usd, '$');
            renderRows('cn', state.cn, '¥');
            renderCashRows();
        }

        function renderRows(type, items, symbol) {
            const container = document.getElementById(type + '-inputs');
            if(!container) return; 

            container.innerHTML = items.map(item => {
                return `
                <div class="pro-grid-row px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors border-b border-gray-50 dark:border-gray-800 last:border-0 text-sm">
                    <div><input type="text" class="input-google w-full font-bold text-textPrimary dark:text-darkText" data-type="${type}" data-id="${item.id}" data-field="ticker" value="${item.ticker}"></div>
                    <div><input type="number" class="input-google w-full text-right font-mono text-textPrimary dark:text-darkText" data-type="${type}" data-id="${item.id}" data-field="shares" value="${item.shares}"></div>
                    <div><input type="number" class="input-google w-full text-right font-mono text-textSecondary dark:text-darkTextSec" data-type="${type}" data-id="${item.id}" data-field="cost" value="${item.cost}"></div>
                    <div><input type="number" class="input-google w-full text-right font-mono text-textPrimary dark:text-darkText" data-type="${type}" data-id="${item.id}" data-field="price" value="${item.price}"></div>
                    
                    <div class="text-right font-mono font-bold text-textPrimary dark:text-darkText" id="val-${type}-${item.id}">--</div>
                    <div class="text-right font-mono font-medium" id="pl-${type}-${item.id}">--</div>
                    <div class="text-right font-mono text-textSecondary dark:text-darkTextSec" id="alloc-${type}-${item.id}">--</div>
                    
                    <div class="flex justify-center"><svg onclick="toggleDeletePopover(event, '${type}', '${item.id}')" class="delete-trigger icon-glass btn-icon w-4 h-4 text-gray-300 dark:text-gray-600 cursor-pointer hover:text-red-500 transition-colors" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></div>
                </div>`;
            }).join('');
            
            container.querySelectorAll('input').forEach(i => i.addEventListener('input', e => handleInput(e.target)));
        }

        function renderCashRows() {
            const container = document.getElementById('cash-inputs');
            if(!container) return;

            container.innerHTML = state.cash.map(item => {
                return `
                <div class="cash-grid-row px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors border-b border-gray-50 dark:border-gray-800 last:border-0 text-sm">
                    <div class="flex items-center gap-1">
                        <select onchange="handleCurrencyChange('${item.id}', this.value)" class="bg-transparent text-xs border-none focus:ring-0 text-textSecondary dark:text-darkTextSec mr-1 cursor-pointer font-bold"><option value="USD" ${item.currency === 'USD'?'selected':''}>$</option><option value="CNY" ${item.currency === 'CNY'?'selected':''}>¥</option></select>
                        <input type="text" class="input-google w-full font-medium text-textPrimary dark:text-darkText" data-type="cash" data-id="${item.id}" data-field="ticker" value="${item.ticker}">
                    </div>
                    <div><input type="number" class="input-google w-full text-right font-mono text-textPrimary dark:text-darkText font-bold" data-type="cash" data-id="${item.id}" data-field="amount" value="${item.amount}"></div>
                    <div class="text-right font-mono font-medium text-textPrimary dark:text-darkText" id="val-cash-${item.id}">--</div>
                    <div class="text-right font-mono text-textSecondary dark:text-darkTextSec" id="alloc-cash-${item.id}">--</div>
                    <div class="flex justify-center"><svg onclick="toggleDeletePopover(event, 'cash', '${item.id}')" class="delete-trigger icon-glass btn-icon w-4 h-4 text-gray-300 dark:text-gray-600 cursor-pointer hover:text-red-500 transition-colors" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></div>
                </div>`;
            }).join('');
            container.querySelectorAll('input').forEach(i => i.addEventListener('input', e => handleInput(e.target)));
        }

        function updateRowValues(type, items, totalVal, symbol) {
            items.forEach(item => {
                const valEl = document.getElementById(`val-${type}-${item.id}`);
                const plEl = document.getElementById(`pl-${type}-${item.id}`);
                const allocEl = document.getElementById(`alloc-${type}-${item.id}`);
                
                if (!valEl) return;

                const val = item.shares * item.price;
                const costBasis = item.shares * item.cost;
                const pl = val - costBasis;
                const plPct = costBasis > 0 ? (pl / costBasis) * 100 : 0;
                const allocPct = totalVal > 0 ? (val / totalVal) * 100 : 0;
                
                const color = pl >= 0 ? 'text-googleGreen' : 'text-googleRed';
                const sign = pl >= 0 ? '+' : '';

                valEl.innerText = `${symbol}${val.toFixed(2)}`;
                
                plEl.className = `text-right font-mono font-medium ${color}`;
                plEl.innerHTML = `${sign}${pl.toFixed(2)}/${sign}${plPct.toFixed(2)}%`;
                
                allocEl.innerText = `${allocPct.toFixed(1)}%`;
            });
        }

        function updateCashRowValues(totalCashRmb, fx) {
            state.cash.forEach(item => {
                const valEl = document.getElementById(`val-cash-${item.id}`);
                const allocEl = document.getElementById(`alloc-cash-${item.id}`);
                
                if(!valEl) return;

                let rmbVal = item.currency === 'USD' ? item.amount * fx : item.amount;
                let allocPct = totalCashRmb > 0 ? (rmbVal / totalCashRmb) * 100 : 0;

                valEl.innerText = `¥${Math.round(rmbVal)}`;
                allocEl.innerText = `${allocPct.toFixed(1)}%`;
            });
        }

        function initCharts() {
            Chart.defaults.font.family = '"Google Sans", "Roboto", sans-serif';
            const tooltipCallback = { label: function(c) { const v=c.raw, d=c.chart.data.datasets[0], s=d.data.reduce((a,b)=>a+b,0), p=s>0?((v/s)*100).toFixed(1)+'%':'0%'; return ` ${Math.round(v).toLocaleString()} (${p})`; } };
            const opts = (cutout, plugins=[]) => ({ responsive: true, maintainAspectRatio: false, borderWidth: 0, cutout: cutout, layout: { padding: 0 }, plugins: { legend: { display: false }, tooltip: { enabled: true, borderWidth: 1, callbacks: tooltipCallback } } });
            
            charts.main = new Chart(document.getElementById('chart-main').getContext('2d'), { 
                type: 'doughnut', 
                data: { labels: ['美股', 'A股', '现金'], datasets: [{ data: [1,1,1], backgroundColor: ['#1a73e8', '#fbbc04', '#34a853'], hoverOffset: 4 }] }, 
                options: opts('55%'),
                plugins: [segmentLabelPlugin]
            });

            charts.usSub = new Chart(document.getElementById('chart-us-sub').getContext('2d'), { type: 'doughnut', data: { datasets: [{ data: [], backgroundColor: [] }] }, options: opts('70%') });
            charts.cnSub = new Chart(document.getElementById('chart-cn-sub').getContext('2d'), { type: 'doughnut', data: { datasets: [{ data: [], backgroundColor: [] }] }, options: opts('70%') });
            charts.cashSub = new Chart(document.getElementById('chart-cash-sub').getContext('2d'), { type: 'doughnut', data: { datasets: [{ data: [], backgroundColor: [] }] }, options: opts('70%') });
        }

        function updateChart(c, d) { c.data.datasets[0].data = d; c.update(); }
        function updateSubChart(c, l, d, co) { c.data.labels = l; c.data.datasets[0].data = d; c.data.datasets[0].backgroundColor = co; c.update(); }
        
        function addItem(t) { 
            const id=Date.now().toString(); 
            if(t==='cash') state.cash.push({id, ticker:'新账户', amount:0, currency:'CNY'}); 
            else state[t].push({id, ticker:'New', shares:0, cost:0, price:0}); 
            
            if(t==='cash') renderCashRows();
            else renderRows(t, state[t], t==='usd'?'$':'¥');
            
            calculate(); 
        }
        
        function toggleDeletePopover(event, type, id) {
            event.stopPropagation();
            const popover = document.getElementById('delete-popover');
            
            if(itemToDelete && itemToDelete.id === id && !popover.classList.contains('hidden')) {
                closePopover();
                return;
            }

            itemToDelete = { type, id };
            const btn = event.currentTarget;
            const rect = btn.getBoundingClientRect();
            
            popover.style.top = (window.scrollY + rect.top + 5) + 'px'; 
            popover.style.left = (window.scrollX + rect.left - 130) + 'px'; 

            popover.classList.remove('hidden');
            requestAnimationFrame(() => {
                popover.classList.remove('opacity-0', 'scale-95');
                popover.classList.add('opacity-100', 'scale-100');
            });
        }

        function closePopover() {
            const popover = document.getElementById('delete-popover');
            popover.classList.remove('opacity-100', 'scale-100');
            popover.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                popover.classList.add('hidden');
                itemToDelete = null;
            }, 100);
        }

        function handleBodyClick(event) {
            const popover = document.getElementById('delete-popover');
            if (!popover.contains(event.target) && !event.target.closest('.delete-trigger')) {
                closePopover();
            }
        }

        document.getElementById('popover-confirm-btn').addEventListener('click', () => {
            if (itemToDelete) {
                const { type, id } = itemToDelete;
                state[type] = state[type].filter(i => i.id !== id);
                
                if(type==='cash') renderCashRows();
                else renderRows(type, state[type], type==='usd'?'$':'¥');
                
                calculate();
                closePopover();
            }
        });

        function handleCurrencyChange(id, v) { 
            const i=state.cash.find(x=>x.id===id); 
            if(i){ i.currency=v; calculate(); } 
        }
        
        function handleInput(t) { 
            if(t.id==='fx-rate'){calculate();return;} 
            const type=t.dataset.type, id=t.dataset.id, field=t.dataset.field; 
            let val=t.value; 
            if(t.type==='number') val=parseFloat(t.value)||0; 
            const item=state[type].find(x=>x.id===id); 
            if(item){ 
                if(type==='cash'&&field==='amount') item.amount=val; 
                else item[field]=val; 
                
                calculate(); 
            } 
        }

        window.onload = function() { 
            initCharts(); 
            loadTheme();
            updatePrivacyUI(); // Ensure UI matches state on load
            renderAllRows(); 
            calculate(); 
            document.getElementById('fx-rate').addEventListener('input', calculate);
        };
    </script>
</body>

</html>
